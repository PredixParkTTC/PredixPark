---
layout: post
Title: Create-a-Python-App-to-stream-Modbus-protocol-in-local
pinned: 0
---

<div>
    <br/>
</div>
<div>
    <span style="font-size: 24px;">
        <b>Nasıl çalışır?</b>
    </span>
</div>
<div>Uygulamanın iki parçası var.</div>
<ol>
    <li>
        <b>SlaveMachine.py</b> içinde tanımlanan Server. Bu server bizim ana makinemiz olmuş oluyor (Slave). Bu içinde tanımlanan Data block'larında stream edilen data'yı saklıyor. DB gibi düşünülebilir, ancak, bir yandan TCP'den gelen request'leri de kabul edip onlara datayı geri modbus ile yolluyor. 
    
    </li>
    <li>
        <b>UpdateServer.py</b> içinde tanımlanan Server'ı update eden coroutine. Bu script'teki kod da sürekli olarak Server'a bağlanıp gerekli coil'deki değeri yazıyor. Bizim implementasyonda "0" coil'ini kullandım.
    
    </li>
</ol>
<div>
    <br/>
</div>
<div>
    <b>SlaveMachine.py</b>
</div>
<div>
    <hr/>
</div>
<div>
    <a href="Create%20a%20Python%20App%20to%20stream%20Modbus%20protocol%20in%20local.resources/SlaveMachine.py">SlaveMachine.py</a>
</div>
<div>
    <br/>
</div>
<div>Bu kodun çalışması için python2 gerekiyor. Ben 2.7'de denedim.. Bu kod için gerekli dependency'ler pip'den yüklenebilir. Python3'de sorun yaşadım.</div>
<div>
    <br/>
</div>
<div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;">
    <div>
        <div>sudo pip2 install pymodbus</div>
        <div>sudo pip2 install cryptography</div>
    </div>
</div>
<div>
    <br/>
</div>
<div>Benim bilgisayarımda 502 port'una bağlanırken access vermedi, sudo ile bağlanmasına izin verdi. 502 dışındaki herşeye bağlanaibliyor olmasına rağmen. Neyse, çalıştırmak için:</div>
<div>
    <br/>
</div>
<div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;">
    <div>
        <div>sudo python2 SlaveMachine.py</div>
    </div>
</div>
<div>
    <br/>
</div>
<div>Bunu bi terminal'de çalışır halde bırakıyoruz.</div>
<div>
    <br/>
</div>
<div>Şu anda aslında PredixMachine'in buna bağlanabiliyor olması gerekir. Gerekli bilgiler şunlar: </div>
<div>
    <br/>
</div>
<div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;">
    <div>
        <div>
            <b>VendorName</b>  = 'TTC'
        
        </div>
        <div>
            <b>ProductCode</b> = 'PredixPark'
        
        </div>
        <div>
            <b>ProductName</b> = 'PredixPark'
        
        </div>
        <div>
            <b>ModelName</b>   = 'PredixPark'
        
        </div>
        <div>
            <b>MajorMinorRevision</b> = '1.0'
        
        </div>
    </div>
    <div>
        <br/>
    </div>
    <div>
        <b>DataCoil </b>= 0
        
        <b></b># data boyutu 1-bit. # 1=Önünde obje var, 0=Yok
    
    </div>
</div>
<div>
    <br/>
</div>
<div>
    <br/>
</div>
<div>
    <b>UpdateServer.py</b>
</div>
<div>
    <hr/>
</div>
<div>
    <a href="Create%20a%20Python%20App%20to%20stream%20Modbus%20protocol%20in%20local.resources/UpdateServer.py">UpdateServer.py</a>
</div>
<div>
    <br/>
</div>
<div>Bu kod Betül'ün sensör'den okuma ve server'daki data coil'ini update etme kısmını içeriyor. Bu da infinite-loop şeklinde yazıldı. Sürekli olarak server'daki data güncellenecek, PredixMachine ne zaman okursa artık o zamanki datayı alacak.</div>
<div>
    <br/>
</div>
<div>Burada RPi diye bir library kullanılıyor. Bu library'nin python2 versiyonunu bulamadım. Neyse ki buradaki pymodbus kodu python3'de arıza çıkarmıyor. Burada pymodbus3 yüklü olmalı.</div>
<div>
    <br/>
</div>
<div>
    <div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);">
        <div>
            <span style="font-size: 12px;">
                <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                    <span style="color: rgb(51, 51, 51);">sudo pip3 install pymodbus3</span>
                </span>
            </span>
        </div>
        <div>
            <span style="font-size: 12px;">
                <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                    <span style="color: rgb(51, 51, 51);">sudo pip3 install cryptography</span>
                </span>
            </span>
        </div>
    </div>
</div>
<div>
    <br/>
</div>
<div>Bunu da bi terminalde çalıştırıp bırakıyoruz.</div>
<div>
    <br/>
</div>
<div>
    <div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;">
        <div>sudo python3 UpdateServer.py</div>
    </div>
</div>
<div>
    <br/>
</div>
<div>
    <b>Önemli Not</b>: Ben bu script'i test edemedim (Raspberry PI kodu içeriyor). Lâkin, çalışıyor olduğunu tahmin ediyorum gözle kontrol ettim.  Sistemin çalışıp çalışmadığını kontrol etmek için (bkz: Test)

</div>
<div>
    <br/>
</div>
<div>
    <br/>
</div>
<div>
    <span style="font-size: 24px;">
        <b>Test</b>:
    
    </span>
</div>
<div>
    <br/>
</div>
<div>Elimde raspberry olmadığı için Raspberry datası aktarmak yerine, kendim bi routine yazıp saniyede bir 1-0 değerleri yükleyen bir script yazdım:</div>
<div>
    <br/>
</div>
<table style="-evernote-table:true;border-collapse:collapse;width:100%;table-layout:fixed;margin-left:0px;">
    <tr>
        <td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:50%;">
            <div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);">
                <div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">import time</span>
                            </span>
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">from pymodbus3.client.sync import ModbusTcpClient</span>
                            </span>
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">client = ModbusTcpClient('127.0.0.1')</span>
                            </span>
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">
                                    <br/>
                                </span>
                            </span>
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">while True:</span>
                            </span>
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">    client.write_coil(0, True)</span>
                            </span>
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">    time.sleep(1.0)</span>
                            </span>
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">    client.write_coil(0, False)</span>
                            </span>
                        </span>
                    </div>
                </div>
                <div>
                    <span style="font-size: 12px;">
                        <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                            <span style="color: rgb(51, 51, 51);">    time.sleep(1.0)</span>
                        </span>
                    </span>
                </div>
            </div>
        </td>
        <td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:50%;">
            <div>
                <a href="Create%20a%20Python%20App%20to%20stream%20Modbus%20protocol%20in%20local.resources/UpdateServerTest.py">UpdateServerTest.py</a>
            </div>
            <div>
                <br/>
            </div>
            <div>Run with:</div>
            <div>
                <br/>
            </div>
            <div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;">
                <div>
                    <div>python3 UpdateServerTest.py</div>
                </div>
            </div>
            <div>
                <br/>
            </div>
        </td>
    </tr>
</table>
<div>
    <br/>
</div>
<div>Ve daha sonra bu datayı da okuyup doğru output alıp almadığımı görmem gerekiyor. Onun için de şunu yazdım.:</div>
<div>
    <br/>
</div>
<table style="-evernote-table:true;border-collapse:collapse;width:100%;table-layout:fixed;margin-left:0px;">
    <tr>
        <td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:50%;">
            <div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);">
                <div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">from pymodbus.client.sync import ModbusTcpClient</span>
                            </span>
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">
                                    <br/>
                                </span>
                            </span>
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">client = ModbusTcpClient('127.0.0.1')</span>
                            </span>
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">result = client.read_coils(0,1)</span>
                            </span>
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 12px;">
                            <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                                <span style="color: rgb(51, 51, 51);">print result.bits[0]</span>
                            </span>
                        </span>
                    </div>
                </div>
                <div>
                    <span style="font-size: 12px;">
                        <span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">
                            <span style="color: rgb(51, 51, 51);">client.close()</span>
                        </span>
                    </span>
                </div>
            </div>
        </td>
        <td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:50%;">
            <div>
                <a href="Create%20a%20Python%20App%20to%20stream%20Modbus%20protocol%20in%20local.resources/ReadCoil.py">ReadCoil.py</a>
            </div>
            <div>
                <br/>
            </div>
            <div>
                <div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;">
                    <div>python2 UpdateServerTest.py</div>
                </div>
            </div>
            <div>
                <br/>
            </div>
        </td>
    </tr>
</table>
<div>
    <br/>
</div>
<div>Bunu diğer iki routine çalışırken ard arda çalıştırdığım zaman</div>
<div>
    <br/>
</div>
<div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;">
    <div>
        <div>Onats-MacBook-Pro:Desktop onatbas$ python2 ReadCoil.py
            
            <br/>
        </div>
        <div>False</div>
        <div>Onats-MacBook-Pro:Desktop onatbas$ python2 ReadCoil.py
            
            <br/>
        </div>
        <div>True</div>
        <div>Onats-MacBook-Pro:Desktop onatbas$ python2 ReadCoil.py
            
            <br/>
        </div>
        <div>True</div>
        <div>Onats-MacBook-Pro:Desktop onatbas$ python2 ReadCoil.py
            
            <br/>
        </div>
        <div>False</div>
        <div>Onats-MacBook-Pro:Desktop onatbas$ python2 ReadCoil.py
            
            <br/>
        </div>
        <div>False</div>
    </div>
    <div>Onats-MacBook-Pro:Desktop onatbas$ python2 ReadCoil.py</div>
    <div>
        <div>True</div>
    </div>
</div>
<div>
    <br/>
</div>
<div>
    <br/>
</div>
<div>
    <br/>
</div>
<div>**END**</div>
<div>
    <hr/>
</div>
<div>
    <br/>
</div>
<div>
    <hr/>
</div>
<div>
    <br/>
</div>
<div>
    <hr/>
</div>
<div>
    <span style="color: rgb(116, 116, 116);">
        <span style="font-size: 11px;">
            <i>
                <br/>
            </i>
        </span>
    </span>
</div>
<div>
    <span style="color: rgb(116, 116, 116);">
        <span style="font-size: 11px;">
            <i>Onat's previous notes:</i>
        </span>
    </span>
</div>
<div>
    <span style="color: rgb(116, 116, 116);">
        <span style="font-size: 11px;">
            <i>Betul's code to get binary info from sensors. </i>
        </span>
    </span>
</div>
<span style="color: rgb(116, 116, 116);">
    <span style="font-size: 11px;">
        <i>
            <a href="Create%20a%20Python%20App%20to%20stream%20Modbus%20protocol%20in%20local.resources/led.py">led.py</a>
            <br/>
            <a href="Create%20a%20Python%20App%20to%20stream%20Modbus%20protocol%20in%20local.resources/helloworld.py">helloworld.py</a>
        </i>
    </span>
</span>
<div>
    <span style="color: rgb(116, 116, 116);">
        <span style="font-size: 11px;">
            <i>
                <br/>
            </i>
        </span>
    </span>
</div>
<div>
    <span style="color: rgb(116, 116, 116);">
        <span style="font-size: 11px;">
            <i>
                <br/>
            </i>
        </span>
    </span>
</div>
<div>
    <span style="color: rgb(116, 116, 116);">
        <span style="font-size: 11px;">
            <i>Use this to stream this information via modbus over tcp : </i>
        </span>
    </span>
</div>
<div>
    <span style="color: rgb(116, 116, 116);">
        <span style="font-size: 11px;">
            <i>
                <a href="https://github.com/bashwork/pymodbus">
                    <span style="color: rgb(116, 116, 116);">https://github.com/bashwork/pymodbus</span>
                </a>
            </i>
        </span>
    </span>
</div>
<div>
    <br/>
</div>